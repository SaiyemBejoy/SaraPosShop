
@{


    ViewBag.Title = "Requisition";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";


}
<style>
    #table-wrapper {
        position: relative;
    }

    #table-scroll {
        height: 680px;
        overflow: auto;
        margin-top: 20px;
    }

    #table-wrapper table {
        width: 100%;
    }

        #table-wrapper table thead th .text {
            position: absolute;
            top: -20px;
            z-index: 2;
            height: 20px;
            width: 35%;
            border: 1px solid red;
        }
</style>

<div class="m-grid__item m-grid__item--fluid m-wrapper">
    <div class="m-content">
        <div class="row">
            <div class="col-lg-12">

                <!--begin::Portlet-->
                <div class="m-portlet m-portlet--rounded" style="border: 1px solid crimson">

                    <div class="m-portlet__body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="m-portlet m-portlet--rounded" style="border: 1px solid darkgreen;">

                                    <div class="m-portlet__body">
                                        <form class="m-form m-form--fit">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-group m-form__group row">
                                                        <label class="col-4 col-form-label">Date:</label>
                                                        <div class="col-8">
                                                            <input class="form-control m-input--air m-input--pill datepicker" style="width: 100px;" value="@ViewBag.dateTime" disabled="disabled">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">

                                                    <div class="form-group m-form__group row">
                                                        <label class="col-5 col-form-label">Requisition#:</label>
                                                        <div class="col-7">
                                                            <input class="form-control m-input--air m-input--pill" value="@ViewBag.GetMaxRequisition" readonly="readonly" style="width: 130px;" id="requisitionNo" type="text">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">

                                                    <div class="form-group m-form__group row">
                                                        <div class="col-8">
                                                            <button type="button" id="orderNow" class="btn m-btn--pill m-btn--air btn-outline-success"> Order Now</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <br />
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <div class="form-group m-form__group row">
                                                        <label class="col-4 col-form-label"><b>Style Name#:</b></label>
                                                        <div class="col-7">
                                                            <input class="form-control m-input--air m-input--pill" type="text" id="styleName" placeholder="Type Style Name" style="width: 250px" autocomplete="off">
                                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group m-form__group row">
                                                        <div class="col-1">
                                                            <button type="button" id="DcproductSearch" class="btn btn-accent m-btn m-btn--icon m-btn--icon-only m-btn--custom m-btn--pill" style="margin-left: -15px;"><i class="la la-search"></i></button>
                                                        </div>
                                                    </div>
                                                </div>                                                 
                                            </div>
                                        </form>
                                        <br />
                                        <div class="m-portlet m-portlet--rounded" style="border: 1px solid darkgreen;">
                                            <div class="m-portlet__head">
                                                <div class="m-portlet__head-caption">
                                                    <div class="m-portlet__head-title">
                                                        <span class="m-portlet__head-icon">
                                                            <i class="la la-thumb-tack"></i>
                                                        </span>
                                                        <h3 class="m-portlet__head-text">
                                                            All Product List
                                                        </h3>
                                                    </div>
                                                </div>

                                            </div>
                                            <div class="m-portlet__body">
                                                <div class="m-section">
                                                    <div class="m-section__content">
                                                        <table class="table table-responsive-sm table-bordered m-table m-table--border-danger m-table--head-bg-primary table-hover " id="requisition">
                                                            <thead>
                                                                <tr>
                                                                    <th class="text-center">BarCode</th>
                                                                    <th class="text-center">Name</th>
                                                                    <th class="text-center">Category</th>
                                                                    <th class="text-center">SubCategory</th>
                                                                    <th class="text-center">Price</th>
                                                                    <th class="text-center">Stock</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody style="background-color: gainsboro" id="listTableBody"></tbody>
                                                        </table>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <div class="m-portlet m-portlet--rounded" style="border: 1px solid darkgreen;">

                                    <div class="m-portlet__body">
                                        <div id="table-wrapper">
                                            <div id="table-scroll">
                                                <table class="table table-responsive-sm table-bordered table-striped table-hover " id="selectedTable">
                                                    <thead>
                                                        <tr>

                                                            <th>BarCode</th>
                                                            <th>Name</th>
                                                            <th>Price</th>
                                                            <th>Qty</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="selectedTableBody" class="table-scroll"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-md-6">

                            </div>

                        </div>
                    </div>
                </div>
                <!--end::Portlet-->
            </div>
        </div>
    </div>
</div>
<script>
    function Validation() {
        var requisitionNo = $("#requisitionNo").val();
        if (requisitionNo === "") {
            toastr.error("Requisition No Cann't be Empty!.");
            $("#requisitionNo").focus();
            return false;
        }
        return true;
    }

    function orderAllDataSave() {
        if (Validation()) {
            var requisitionNo = $("#requisitionNo").val();
            var allRequisitionItem = [];
            allRequisitionItem.length = 0;
            $.each($("#selectedTableBody tr"),
                function() {
                    allRequisitionItem.push({
                        Barcode: $(this).find('td:eq(0)').text(),
                        ItemName: $(this).find('td:eq(1)').text(),
                        Price: $(this).find('td:eq(2)').text(),
                        RqsnQuantity: $(this).find('.RqsnQuantity').val()
                    });
                });
            var dataObject = {
                'RequisitionNo': requisitionNo,
                'RequisitionMainItemList': allRequisitionItem
            }
            var dataList = JSON.stringify({ objRequisitionMainModel: dataObject });
            if (allRequisitionItem.length) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: 'json',
                    url: '@Url.Action("SaveAllRequisitionData", "Requisition")',
                    data: dataList,
                    beforeSend: function () {
                        $('#cover-spin').show();
                    },
                success: function (data) {
                    if (data.isRedirect) {
                        window.setTimeout(function() {
                            window.location = data.redirectUrl;
                        },1000);
                        toastr.success("Save Successfully.");
                    }
                    if (requisitionNo !== "") {
                        window.open('/Requisition/ShowReport?requisitionNo=' + requisitionNo, '_blank');
                    }
                }
            });
        } else {
                toastr.error("Table Data Cann't Be Empty!");
                $('#cover-spin').hide();
            }
        }
    }

    function appendTableForRequisition(barcode,itemName,price) {
        $("#selectedTableBody").append('<tr>' +
            '<td>' +
            barcode +
            '</td>' +
            '<td>' +
            itemName +
            '</td>' +
            '<td>' +
            price +
            '</td>' +
            '<td style ="width: 20%">' +
            '<input type="number" class="form-control input-circle RqsnQuantity" id="RqsnQuantity" value="' + 1 + '"' +
            '</td>' +
            '<td>' +
            '<a href="#" class=" deleteItem btn btn-danger m-btn m-btn--icon m-btn--icon-only m-btn--custom m-btn--pill"><i class="la la-archive"></i></a>' +
            '</td>' +
            '</tr>');

        scrollStopNumberField();
    }

    function scrollStopNumberField() {
        $('input[type=number]').on('mousewheel', function (e) {
            $(e.target).blur();
        });
    }

    jQuery(document).ready(function () {
        $("#styleName").focus();

        $('#DcproductSearch').on('click', function () {
            var styleNameV = $("#styleName").val();
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: '/Requisition/GetDcProductByStyleName/',
                data: { styleName: styleNameV },
                beforeSend: function () {
                    $('#cover-spin').show();
                },
                success: function (data) {
                    var dcProductQty = data.length;

                    $('#requisition').DataTable().destroy();
                    $("#listTableBody").html("");
                    for (var i = 0; i < dcProductQty; i++) {
                        $("#listTableBody").append('<tr>' +
                            '<td>' +
                            data[i].Barcode +
                            '</td>' +
                            '<td style="text-align: center; width: 200%;">' +
                            data[i].ItemName +
                            '</td>' +
                            '<td>' +
                            data[i].Category +
                            '</td>' +
                            '<td>' +
                            data[i].SubCategory +
                            '</td>' +
                            '<td>' +
                            data[i].SalePrice +
                            '</td>' +
                            '<td>' +
                            data[i].Quantity +
                            '</td>' +
                            '</tr>');
                    }
                    $("#requisition").dataTable();
                    $('#cover-spin').hide();
                }
            });

        });
        @*var url = '@DAL.DBManager.DatabaseConfiguration.WarehouseApi' + 'WarehouseStock';
       var table= $("#requisition").dataTable({
            processing: true,
            ajax: { url: url, dataSrc: ""},
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            type: "GET",
            columns: [
                { data: "barCode" },
                { data: "itemName" },
                { data: "category" },
                { data: "subCategory" },
                { data: "salePrice" },
                { data: "quantity" }
            ]
        });*@

        //Data Save Start

        //End
        $("#orderNow").click(function () {

                orderAllDataSave();

        });
        //Tis is for Row click event

        $("body").on("click", "#listTableBody tr", function () {
            var barcode = $(this).find('td:eq(0)').html();
            var itemName = $(this).find('td:eq(1)').html();
            var price = $(this).find('td:eq(4)').html();

            var allItemCode = [];
            allItemCode.length = 0;
            var checker = true;
            $.each($("#selectedTableBody tr"), function () {
                var value = $(this).find('td:eq(0)').html();
                allItemCode.push({
                    value
                });
            });
            if (allItemCode.length > 0) {
                $.each(allItemCode, function (i, val) {
                    if (barcode === val.value) {
                        checker = false;
                    }
                });
                if (checker) {
                    appendTableForRequisition(barcode, itemName, price);

                } else {
                    toastr.warning("This Item Already Exist.");
                }
            } else {
                appendTableForRequisition(barcode, itemName, price);
                }

        });
        //end
        //Delete from grid Table
        $(document).on('click', 'a.deleteItem', function (e) {
            e.preventDefault();
            var self = $(this);
            if (self != null) {
                $(this).parents('tr').css("background-color", "#dc143c").fadeOut(800, function () {
                    $(this).remove();

                });
            } else {
                //t("delete hoi ni");
                toastr.error("Data cann't delete");
            }
        });
        //End
    });

</script>
